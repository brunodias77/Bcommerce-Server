# Auth Service - Commands e Queries

## üìã Vis√£o Geral

Este documento descreve todos os Commands e Queries planejados para o Auth Service, seguindo os padr√µes CQRS e Mediator definidos no BuildingBlocks.

---

## üîê Autentica√ß√£o

### Commands

#### **RegisterUserCommand**
Registra um novo usu√°rio no sistema.

**Request:**
```csharp
- Email: string (required)
- Password: string (required, min 8 chars)
- FullName: string (required, max 255 chars)
- Phone: string (optional, max 20 chars)
- BirthDate: DateTime? (optional)
```

**Response:**
```csharp
- UserId: string
- Message: string
```

**Valida√ß√µes:**
- Email √∫nico no sistema
- Senha atende requisitos (mai√∫scula, min√∫scula, n√∫mero)
- Email em formato v√°lido
- Nome completo n√£o vazio

**Efeitos Colaterais:**
- Cria registro na tabela `AspNetUsers`
- Cria registro na tabela `users` (perfil)
- Gera `AccountToken` para ativa√ß√£o de conta
- Publica evento `UserRegisteredEvent`

---

#### **LoginCommand**
Realiza login do usu√°rio e gera tokens de acesso.

**Request:**
```csharp
- Email: string (required)
- Password: string (required)
- IpAddress: string (optional)
- UserAgent: string (optional)
```

**Response:**
```csharp
- AccessToken: string (JWT)
- RefreshToken: string
- ExpiresIn: int (segundos)
- TokenType: string ("Bearer")
```

**Valida√ß√µes:**
- Credenciais v√°lidas
- Conta ativa (n√£o bloqueada)
- Email confirmado (se configurado)

**Efeitos Colaterais:**
- Cria `RefreshToken`
- Atualiza `LastLoginAt` do usu√°rio
- Registra `SecurityLog` (LOGIN_SUCCESS)
- Publica evento `UserLoggedInEvent`

---

#### **RefreshTokenCommand**
Renova o token de acesso usando um refresh token v√°lido.

**Request:**
```csharp
- RefreshToken: string (required)
```

**Response:**
```csharp
- AccessToken: string (novo JWT)
- RefreshToken: string (novo refresh token)
- ExpiresIn: int
- TokenType: string
```

**Valida√ß√µes:**
- Refresh token existe e est√° ativo
- Refresh token n√£o expirado
- Refresh token n√£o revogado
- Usu√°rio ainda ativo

**Efeitos Colaterais:**
- Revoga refresh token antigo
- Cria novo `RefreshToken`
- Registra `SecurityLog` (TOKEN_REFRESHED)

---

#### **LogoutCommand**
Realiza logout do usu√°rio revogando seus tokens.

**Request:**
```csharp
- UserId: string (required)
- RefreshToken: string (optional)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Efeitos Colaterais:**
- Revoga refresh token espec√≠fico ou todos do usu√°rio
- Registra `SecurityLog` (LOGOUT)
- Publica evento `UserLoggedOutEvent`

---

#### **ForgotPasswordCommand**
Inicia processo de recupera√ß√£o de senha.

**Request:**
```csharp
- Email: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Email existe no sistema

**Efeitos Colaterais:**
- Gera `AccountToken` tipo PASSWORD_RESET
- Publica evento `PasswordResetRequestedEvent` (para envio de email)
- Registra `SecurityLog` (PASSWORD_RESET_REQUESTED)

---

#### **ResetPasswordCommand**
Redefine a senha do usu√°rio usando token v√°lido.

**Request:**
```csharp
- Token: string (required)
- NewPassword: string (required, min 8 chars)
- ConfirmPassword: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Token existe e est√° ativo
- Token n√£o expirado
- Token tipo PASSWORD_RESET
- Senhas coincidem
- Nova senha atende requisitos

**Efeitos Colaterais:**
- Atualiza senha do usu√°rio
- Marca token como `UsedAt`
- Revoga todos os refresh tokens do usu√°rio
- Registra `SecurityLog` (PASSWORD_RESET_SUCCESS)
- Publica evento `PasswordResetCompletedEvent`

---

#### **ChangePasswordCommand**
Altera senha do usu√°rio autenticado.

**Request:**
```csharp
- UserId: string (required)
- CurrentPassword: string (required)
- NewPassword: string (required, min 8 chars)
- ConfirmPassword: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Senha atual correta
- Senhas novas coincidem
- Nova senha diferente da atual
- Nova senha atende requisitos

**Efeitos Colaterais:**
- Atualiza senha
- Revoga todos refresh tokens (for√ßa re-login)
- Registra `SecurityLog` (PASSWORD_CHANGED)
- Publica evento `PasswordChangedEvent`

---

#### **ActivateAccountCommand**
Ativa conta de usu√°rio usando token de ativa√ß√£o.

**Request:**
```csharp
- Token: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
- UserId: string
```

**Valida√ß√µes:**
- Token existe e est√° ativo
- Token n√£o expirado
- Token tipo ACCOUNT_ACTIVATION
- Conta ainda n√£o ativada

**Efeitos Colaterais:**
- Marca `EmailConfirmed = true` no Identity
- Marca token como `UsedAt`
- Registra `SecurityLog` (ACCOUNT_ACTIVATED)
- Publica evento `AccountActivatedEvent`

---

#### **ResendActivationTokenCommand**
Reenvia token de ativa√ß√£o de conta.

**Request:**
```csharp
- Email: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Email existe
- Conta ainda n√£o ativada

**Efeitos Colaterais:**
- Revoga tokens anteriores do tipo ACCOUNT_ACTIVATION
- Gera novo `AccountToken`
- Publica evento `ActivationTokenResentEvent`

---

## üë§ Gerenciamento de Perfil

### Commands

#### **UpdateProfileCommand**
Atualiza informa√ß√µes do perfil do usu√°rio.

**Request:**
```csharp
- UserId: string (required)
- FullName: string (optional, max 255)
- Phone: string (optional, max 20)
- BirthDate: DateTime? (optional)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Usu√°rio existe
- Nome v√°lido se fornecido
- Telefone em formato v√°lido se fornecido

**Efeitos Colaterais:**
- Atualiza registro na tabela `users`
- Atualiza `UpdatedAt`
- Publica evento `ProfileUpdatedEvent`

---

#### **UpdateEmailCommand**
Inicia processo de altera√ß√£o de email.

**Request:**
```csharp
- UserId: string (required)
- NewEmail: string (required)
- Password: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Senha correta
- Novo email √∫nico no sistema
- Email em formato v√°lido

**Efeitos Colaterais:**
- Gera token de confirma√ß√£o
- Publica evento `EmailChangeRequestedEvent`
- Registra `SecurityLog` (EMAIL_CHANGE_REQUESTED)

---

#### **ConfirmEmailChangeCommand**
Confirma altera√ß√£o de email usando token.

**Request:**
```csharp
- Token: string (required)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Token v√°lido e n√£o expirado
- Novo email ainda dispon√≠vel

**Efeitos Colaterais:**
- Atualiza email no Identity e tabela users
- Marca token como usado
- Registra `SecurityLog` (EMAIL_CHANGED)
- Publica evento `EmailChangedEvent`

---

#### **DeleteAccountCommand**
Desativa ou exclui conta de usu√°rio.

**Request:**
```csharp
- UserId: string (required)
- Password: string (required)
- Reason: string (optional)
```

**Response:**
```csharp
- Success: bool
- Message: string
```

**Valida√ß√µes:**
- Senha correta
- Usu√°rio existe

**Efeitos Colaterais:**
- Soft delete ou hard delete (conforme configura√ß√£o)
- Revoga todos tokens
- Registra `SecurityLog` (ACCOUNT_DELETED)
- Publica evento `AccountDeletedEvent`

---

## üîç Queries

### **GetUserProfileQuery**
Obt√©m perfil completo do usu√°rio.

**Request:**
```csharp
- UserId: string (required)
```

**Response:**
```csharp
- UserId: string
- Email: string
- FullName: string
- Phone: string
- BirthDate: DateTime?
- CreatedAt: DateTime
- UpdatedAt: DateTime
- LastLoginAt: DateTime?
- EmailConfirmed: bool
```

---

### **GetUserByEmailQuery**
Busca usu√°rio por email.

**Request:**
```csharp
- Email: string (required)
```

**Response:**
```csharp
- UserId: string
- Email: string
- FullName: string
- EmailConfirmed: bool
- IsActive: bool
```

---

### **GetActiveRefreshTokensQuery**
Lista refresh tokens ativos do usu√°rio.

**Request:**
```csharp
- UserId: string (required)
```

**Response:**
```csharp
- Tokens: List<RefreshTokenDto>
  - Id: Guid
  - Token: string (masked)
  - CreatedAt: DateTime
  - ExpiresAt: DateTime
  - IsActive: bool
```

---

### **GetSecurityLogsQuery**
Obt√©m logs de seguran√ßa do usu√°rio (paginado).

**Request:**
```csharp
- UserId: string (required)
- PageNumber: int (default 1)
- PageSize: int (default 20)
- EventType: string (optional)
- StartDate: DateTime? (optional)
- EndDate: DateTime? (optional)
```

**Response:**
```csharp
- PagedResult<SecurityLogDto>
  - Id: Guid
  - EventType: string
  - IpAddress: string
  - Message: string
  - CreatedAt: DateTime
```

---

### **ValidateTokenQuery**
Valida se um token (JWT ou refresh) √© v√°lido.

**Request:**
```csharp
- Token: string (required)
- TokenType: TokenType (AccessToken/RefreshToken)
```

**Response:**
```csharp
- IsValid: bool
- UserId: string (if valid)
- ExpiresAt: DateTime (if valid)
- Message: string
```

---

### **GetUserRolesQuery**
Obt√©m roles (perfis) do usu√°rio.

**Request:**
```csharp
- UserId: string (required)
```

**Response:**
```csharp
- Roles: List<string>
```

---

### **CheckEmailAvailabilityQuery**
Verifica se email est√° dispon√≠vel.

**Request:**
```csharp
- Email: string (required)
```

**Response:**
```csharp
- IsAvailable: bool
```

---

## üìä Domain Events

### Eventos Publicados pelo Auth Service

1. **UserRegisteredEvent**
   - **Quando:** Usu√°rio criado com sucesso
   - **Dados:** UserId, Email, FullName
   - **Handlers:** Envio de email de ativa√ß√£o

2. **UserLoggedInEvent**
   - **Quando:** Login bem-sucedido
   - **Dados:** UserId, IpAddress, Timestamp
   - **Handlers:** Atualiza√ß√£o de m√©tricas

3. **UserLoggedOutEvent**
   - **Quando:** Logout realizado
   - **Dados:** UserId, Timestamp

4. **PasswordResetRequestedEvent**
   - **Quando:** Solicita√ß√£o de reset de senha
   - **Dados:** UserId, Email, Token
   - **Handlers:** Envio de email com link

5. **PasswordResetCompletedEvent**
   - **Quando:** Senha resetada com sucesso
   - **Dados:** UserId, Timestamp

6. **PasswordChangedEvent**
   - **Quando:** Senha alterada pelo usu√°rio
   - **Dados:** UserId, Timestamp
   - **Handlers:** Notifica√ß√£o por email

7. **AccountActivatedEvent**
   - **Quando:** Conta ativada
   - **Dados:** UserId, Email, Timestamp

8. **ProfileUpdatedEvent**
   - **Quando:** Perfil atualizado
   - **Dados:** UserId, UpdatedFields

9. **EmailChangedEvent**
   - **Quando:** Email alterado
   - **Dados:** UserId, OldEmail, NewEmail

10. **AccountDeletedEvent**
    - **Quando:** Conta exclu√≠da
    - **Dados:** UserId, Email, Reason

---

## üîí Seguran√ßa e Valida√ß√µes

### Pol√≠ticas de Senha (Identity)
- M√≠nimo 8 caracteres
- Pelo menos 1 d√≠gito
- Pelo menos 1 min√∫scula
- Pelo menos 1 mai√∫scula
- Caracteres especiais opcionais
- 1 caractere √∫nico

### Tokens
- **Access Token (JWT):** Expira em 15 minutos
- **Refresh Token:** Expira em 7 dias
- **Account Activation:** Expira em 24 horas
- **Password Reset:** Expira em 1 hora

### Rate Limiting (Recomendado)
- **Login:** 5 tentativas por 15 minutos
- **Password Reset:** 3 requisi√ß√µes por hora
- **Resend Activation:** 3 requisi√ß√µes por hora

---

## üìÅ Estrutura de Pastas Sugerida

```
AuthService.Application/
‚îú‚îÄ‚îÄ Commands/
‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RegisterUser/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RegisterUserCommand.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RegisterUserCommandHandler.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RegisterUserCommandValidator.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Login/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshToken/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Logout/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ForgotPassword/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ResetPassword/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChangePassword/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ActivateAccount/
‚îÇ   ‚îî‚îÄ‚îÄ Profile/
‚îÇ       ‚îú‚îÄ‚îÄ UpdateProfile/
‚îÇ       ‚îú‚îÄ‚îÄ UpdateEmail/
‚îÇ       ‚îú‚îÄ‚îÄ ConfirmEmailChange/
‚îÇ       ‚îî‚îÄ‚îÄ DeleteAccount/
‚îú‚îÄ‚îÄ Queries/
‚îÇ   ‚îú‚îÄ‚îÄ GetUserProfile/
‚îÇ   ‚îú‚îÄ‚îÄ GetUserByEmail/
‚îÇ   ‚îú‚îÄ‚îÄ GetActiveRefreshTokens/
‚îÇ   ‚îú‚îÄ‚îÄ GetSecurityLogs/
‚îÇ   ‚îú‚îÄ‚îÄ ValidateToken/
‚îÇ   ‚îú‚îÄ‚îÄ GetUserRoles/
‚îÇ   ‚îî‚îÄ‚îÄ CheckEmailAvailability/
‚îú‚îÄ‚îÄ Events/
‚îÇ   ‚îú‚îÄ‚îÄ UserRegisteredEvent.cs
‚îÇ   ‚îú‚îÄ‚îÄ UserLoggedInEvent.cs
‚îÇ   ‚îú‚îÄ‚îÄ PasswordResetRequestedEvent.cs
‚îÇ   ‚îî‚îÄ‚îÄ ... (outros eventos)
‚îú‚îÄ‚îÄ EventHandlers/
‚îÇ   ‚îú‚îÄ‚îÄ UserRegisteredEventHandler.cs
‚îÇ   ‚îî‚îÄ‚îÄ ... (outros handlers)
‚îî‚îÄ‚îÄ DTOs/
    ‚îú‚îÄ‚îÄ Auth/
    ‚îî‚îÄ‚îÄ Profile/
```

---

## üéØ Pr√≥ximos Passos

1. ‚úÖ Implementar Commands de autentica√ß√£o b√°sica (Register, Login, Refresh)
2. ‚úÖ Implementar Commands de recupera√ß√£o de senha
3. ‚úÖ Implementar Queries de perfil
4. ‚úÖ Adicionar valida√ß√µes com FluentValidation
5. ‚úÖ Implementar Events e Handlers
6. ‚úÖ Adicionar testes unit√°rios
7. ‚úÖ Implementar rate limiting
8. ‚úÖ Documentar APIs no Swagger

---

## üìù Observa√ß√µes Importantes

- Todos os Commands devem ter valida√ß√£o via FluentValidation ou ValidationHandler
- Todas as opera√ß√µes sens√≠veis devem gerar SecurityLog
- Erros devem retornar ApiResponse com estrutura consistente
- Usar CancellationToken em todos os m√©todos ass√≠ncronos
- Seguir padr√£o CQRS rigorosamente (Commands alteram estado, Queries apenas leem)
- Events devem ser tratados de forma ass√≠ncrona e n√£o devem bloquear o fluxo principal